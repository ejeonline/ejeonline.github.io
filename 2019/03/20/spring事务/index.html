<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="低端码农技术整理，如有疑问欢迎大佬指正，联系邮箱78606393@qq.com"><title>spring事务 | 二开的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">spring事务</h1><a id="logo" href="/.">二开的博客</a><p class="description">二营长等你很久了！</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">spring事务</h1><div class="post-meta">Mar 20, 2019<span> | </span><span class="category"><a href="/categories/Spring/">Spring</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring事务的用法与原理"><span class="toc-number">1.</span> <span class="toc-text">Spring事务的用法与原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#介绍"><span class="toc-number">1.0.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务的特性"><span class="toc-number">1.0.2.</span> <span class="toc-text">事务的特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#核心接口"><span class="toc-number">1.0.3.</span> <span class="toc-text">核心接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PlatformTransactionManager"><span class="toc-number">1.0.3.1.</span> <span class="toc-text">PlatformTransactionManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TransactionStatus"><span class="toc-number">1.0.3.2.</span> <span class="toc-text">TransactionStatus</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TransactionDefinition"><span class="toc-number">1.0.3.3.</span> <span class="toc-text">TransactionDefinition</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务的属性"><span class="toc-number">1.1.</span> <span class="toc-text">事务的属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#传播行为"><span class="toc-number">1.1.1.</span> <span class="toc-text">传播行为</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#support-存在与否"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">support(存在与否)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#required"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">required</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#required-new"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">required_new</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mandatory强制的"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">mandatory强制的</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#not-supported"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">not_supported</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#never"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">never</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nested"><span class="toc-number">1.1.1.7.</span> <span class="toc-text">nested</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#隔离级别"><span class="toc-number">1.1.2.</span> <span class="toc-text">隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#事务并发问题"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">事务并发问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Read-Committed"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">Read Committed</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Repeatable-Read"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">Repeatable Read</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Serializable"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">Serializable</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他"><span class="toc-number">1.1.3.</span> <span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#只读"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">只读</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#事务超时"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">事务超时</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用法示例"><span class="toc-number">1.2.</span> <span class="toc-text">用法示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#异常触发回滚的示例"><span class="toc-number">1.2.1.</span> <span class="toc-text">异常触发回滚的示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RuntimeException时不回滚的事务"><span class="toc-number">1.2.2.</span> <span class="toc-text">RuntimeException时不回滚的事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#作用于类上"><span class="toc-number">1.2.3.</span> <span class="toc-text">作用于类上</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置以非事务方式运行"><span class="toc-number">1.2.4.</span> <span class="toc-text">设置以非事务方式运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置传播行为和隔离级别"><span class="toc-number">1.2.5.</span> <span class="toc-text">设置传播行为和隔离级别</span></a></li></ol></li></ol></div></div><div class="post-content"><h2 id="Spring事务的用法与原理"><a href="#Spring事务的用法与原理" class="headerlink" title="Spring事务的用法与原理"></a>Spring事务的用法与原理</h2><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>Spring事务的本质其实就是数据库对事务的支持，没有数据库的事务支持，spring是无法提供事务功能的。对于纯JDBC操作数据库，想要用到事务，可以按照以下步骤进行：</p>
<ol>
<li>获取连接 Connection con = DriverManager.getConnection()</li>
<li>开启事务con.setAutoCommit(true/false);</li>
<li>执行CRUD</li>
<li>提交事务/回滚事务 con.commit() / con.rollback();</li>
<li>关闭连接 conn.close();</li>
</ol>
<p>使用Spring的事务管理功能后，我们可以不再写步骤 2 和 4 的代码，而是由Spirng 自动完成。Spring事务处理模块是通过AOP功能来实现声明式事务处理的，具体操作（比如事务实行的配置和读取，事务对象的抽象），用TransactionProxyFactoryBean接口来使用AOP功能，生成proxy代理对象，通过TransactionInterceptor完成对代理方法的拦截，将事务处理的功能编织到拦截的方法中。说得更详细一点：</p>
<p>（1）Spring事务处理模块是通过AOP功能为没有编写事务代码但加上了@Transactional注解的类生成代理。</p>
<p>（2）生成代理的过程中会读取@Transactional注解中的配置，比如传播行为、隔离级别、事务超时等。</p>
<p>（3）生成的代理会拦截目标对象的外部方法调用，自动开启事务、自动提交事务或回滚。</p>
<h4 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h4><p>Atomicity原子性：一个事务要么全部执行,要么不执行；</p>
<p>Consistency一致性：事务的运行并不改变数据库中数据的一致性，例如检查约束、非空约束、主键约束、外键约束；</p>
<p>Isolation隔离性：两个以上的事务不会出现交错执行的状态；</p>
<p>Durability持久性：事务执行成功以后,该事务对数据库所作的更改便是持久的保存在数据库之中，不会无缘无故的回滚；</p>
<h4 id="核心接口"><a href="#核心接口" class="headerlink" title="核心接口"></a>核心接口</h4><p><img src="/2019/03/20/spring事务/20180202232828622.png" alt="img"></p>
<p>Spring并不直接管理事务，而是提供了多种事务管理器，他们将事务管理的职责委托给Hibernate或者JTA等持久化机制所提供的相关平台框架的事务来实现。 Spring 框架中，涉及到事务管理的 API 大约有100个左右，其中最重要的有三个：TransactionDefinition、PlatformTransactionManager、TransactionStatus。</p>
<h5 id="PlatformTransactionManager"><a href="#PlatformTransactionManager" class="headerlink" title="PlatformTransactionManager"></a>PlatformTransactionManager</h5><p>Spring事务管理器的接口是org.springframework.transaction.PlatformTransactionManager，通过这个接口，Spring为各个平台如JDBC、Hibernate等都提供了对应的事务管理器，但是具体的实现就是各个平台自己的事情了。主要包含三个方法：</p>
<p>（1）getTransaction获取事务状态；</p>
<p>（2）commit提交；</p>
<p>（3）rollback回滚；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 由TransactionDefinition得到TransactionStatus对象</span></span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">	<span class="comment">// 提交</span></span><br><span class="line">	<span class="function">Void <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 回滚</span></span><br><span class="line">	<span class="function">Void <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据底层所使用的不同的持久化 API 或框架，使用如下：</p>
<p>DataSourceTransactionManager：适用于使用JDBC和iBatis进行数据持久化操作的情况，在定义时需要提供底层的数据源作为其属性，也就是 DataSource。<br>HibernateTransactionManager：适用于使用Hibernate进行数据持久化操作的情况，与 HibernateTransactionManager 对应的是 SessionFactory。</p>
<p>JpaTransactionManager：适用于使用JPA进行数据持久化操作的情况，与 JpaTransactionManager 对应的是 EntityManagerFactory。</p>
<h5 id="TransactionStatus"><a href="#TransactionStatus" class="headerlink" title="TransactionStatus"></a>TransactionStatus</h5><p>PlatformTransactionManager.getTransaction(…) 方法返回一个 TransactionStatus 对象。返回的TransactionStatus 对象可能代表一个新的或已经存在的事务（如果在当前调用堆栈有一个符合条件的事务）。TransactionStatus 接口提供了一个简单的控制事务执行和查询事务状态的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionStatus</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNewTransaction</span><span class="params">()</span></span>; <span class="comment">// 是否是新的事物</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasSavepoint</span><span class="params">()</span></span>; <span class="comment">// 是否有恢复点</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRollbackOnly</span><span class="params">()</span></span>;  <span class="comment">// 设置为只回滚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRollbackOnly</span><span class="params">()</span></span>; <span class="comment">// 是否为只回滚</span></span><br><span class="line">    <span class="keyword">boolean</span> isCompleted; <span class="comment">// 是否已完成</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="TransactionDefinition"><a href="#TransactionDefinition" class="headerlink" title="TransactionDefinition"></a>TransactionDefinition</h5><p>org.springframework.transaction.TransactionDefinition，它用于定义一个事务。它包含了事务的静态属性，比如：事务传播行为、隔离级别、超时时间等等。</p>
<p>2.3 TransactionDefinition<br>org.springframework.transaction.TransactionDefinition，它用于定义一个事务。它包含了事务的静态属性，比如：事务传播行为、隔离级别、超时时间等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPropagationBehavior</span><span class="params">()</span></span>; <span class="comment">// 返回事务的传播行为</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIsolationLevel</span><span class="params">()</span></span>; <span class="comment">// 返回事务的隔离级别，事务管理器根据它来控制另外一个事务可以看到本事务内的哪些数据</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getTimeout</span><span class="params">()</span></span>;  <span class="comment">// 返回事务必须在多少秒内完成</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span></span>; <span class="comment">// 事务是否只读，事务管理器能够根据这个返回值进行优化，确保事务是只读的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事务的属性"><a href="#事务的属性" class="headerlink" title="事务的属性"></a>事务的属性</h3><h4 id="传播行为"><a href="#传播行为" class="headerlink" title="传播行为"></a>传播行为</h4><h5 id="support-存在与否"><a href="#support-存在与否" class="headerlink" title="support(存在与否)"></a>support(存在与否)</h5><p>PROPAGATION_SUPPORTS：支持当前事务，如果当前没有事务，就以非事务方式执行。</p>
<h5 id="required"><a href="#required" class="headerlink" title="required"></a>required</h5><p>PROPAGATION_REQUIRED：支持当前事务，如果当前没有事务，就新建一个事务。这是最常见的选择。</p>
<p>使用spring声明式事务，spring使用AOP来支持声明式事务，会根据事务属性，自动在方法调用之前决定是否开启一个事务，并在方法执行之后决定事务提交或回滚事务。例如单独调用一个PROPAGATION_REQUIRED的 methodB相当于：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Main&#123; </span><br><span class="line">    Connection con=<span class="keyword">null</span>; </span><br><span class="line">    <span class="keyword">try</span>&#123; </span><br><span class="line">        con = getConnection(); </span><br><span class="line">        con.setAutoCommit(<span class="keyword">false</span>); </span><br><span class="line">        <span class="comment">//方法调用</span></span><br><span class="line">        methodB(); </span><br><span class="line">        <span class="comment">//提交事务</span></span><br><span class="line">        con.commit(); </span><br><span class="line">	&#125; <span class="keyword">catch</span>(RuntimeException ex) &#123; </span><br><span class="line">        <span class="comment">//回滚事务</span></span><br><span class="line">        con.rollback();   </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123; </span><br><span class="line">        <span class="comment">//释放资源</span></span><br><span class="line">        closeCon(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果methodB是在一个事务方法methodA中调用，那么对于methodB的调用会加入到methodA的事务当中。</p>
<h5 id="required-new"><a href="#required-new" class="headerlink" title="required_new"></a>required_new</h5><p>PROPAGATION_REQUIRED_NEW：表示当前方法必须运行在它自己的事务中。一个新的事务将被启动。如果存在当前事务，在该方法执行期间，当前事务会被挂起。</p>
<h5 id="mandatory强制的"><a href="#mandatory强制的" class="headerlink" title="mandatory强制的"></a>mandatory强制的</h5><p>PROPAGATION_MANDATORY：支持当前事务，如果当前没有事务，就抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(“Transaction propagation ‘mandatory’ but no existing transaction found”)</span><br></pre></td></tr></table></figure>
<h5 id="not-supported"><a href="#not-supported" class="headerlink" title="not_supported"></a>not_supported</h5><p>PROPAGATION_NOT_SUPPORTED: 表示该方法不应该运行在事务中。如果存在当前事务，在该方法运行期间，当前事务将被挂起。</p>
<h5 id="never"><a href="#never" class="headerlink" title="never"></a>never</h5><p>PROPAGATION_NEVER: 表示当前方法不应该运行在事务上下文中。如果当前正有一个事务在运行，则会抛出异常。</p>
<h5 id="nested"><a href="#nested" class="headerlink" title="nested"></a>nested</h5><p>PROPAGATION_NESTED: 表示如果当前已经存在一个事务，那么该方法将会在嵌套事务中运行。嵌套的事务可以独立于当前事务进行单独地提交或回滚。如果当前事务不存在，那么其行为与PROPAGATION_REQUIRED一样。注意各厂商对这种传播行为的支持是有所差异的。可以参考资源管理器的文档来确认它们是否支持嵌套事务</p>
<blockquote>
<p>1.嵌套事务一个非常重要的概念就是内层事务依赖于外层事务。<br>2.外层事务失败时，会回滚内层事务所做的动作。<br>3.而内层事务操作失败并不会引起外层事务的回滚。嵌套事务是外部事务的一部分，只有当外部事务成功之后嵌套事务才会被提交。</p>
</blockquote>
<p>PROPAGATION_NESTED 与PROPAGATION_REQUIRES_NEW的区别:它们非常类似,都像一个嵌套事务，如果不存在一个活动的事务，都会开启一个新的事务。使用 PROPAGATION_REQUIRES_NEW时，内层事务与外层事务就像两个独立的事务一样，一旦内层事务进行了提交后，外层事务不能对其进行回滚。两个事务互不影响。两个事务不是一个真正的嵌套事务。</p>
<h4 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h4><p>隔离级别定义了一个事务可能受其他并发事务影响的程度。</p>
<h5 id="事务并发问题"><a href="#事务并发问题" class="headerlink" title="事务并发问题"></a>事务并发问题</h5><p>（1）脏读 Dirty reads</p>
<p>脏读发生在一个事务读取了另一个事务改写但尚未提交的数据时。如果改写在稍后被回滚了，那么第一个事务获取的数据就是无效的。</p>
<p>（2）不可重复读 Nonrepeatable read</p>
<p>不可重复读发生在一个事务执行相同的查询两次或两次以上，但是每次都得到不同的数据时。这通常是因为另一个并发事务在两次查询期间进行了更新。</p>
<p>（3）幻读 Phantom read</p>
<p>幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录。</p>
<p>从总的结果来看, 似乎不可重复读和幻读都表现为两次读取的结果不一致。但如果你从控制的角度来看, 两者的区别就比较大：</p>
<p>对于前者，只需要锁住满足条件的记录；<br>对于后者，要锁住满足条件及其相近的记录；<br>√: 可能出现 ×: 不会出现</p>
<p>脏读                                       不可重复读    幻读<br>Read Uncommitted                   √                  √<br>Read Committed                       ×                  √<br>Repeatable Read                      ×                   ×<br>Serializable                               ×                   ×</p>
<p>MySQL的默认事务隔离级别是：Repeatable Read</p>
<h5 id="Read-Committed"><a href="#Read-Committed" class="headerlink" title="Read Committed"></a>Read Committed</h5><p>在提交读(READ COMMITTED)级别中，基于锁机制并发控制的DBMS需要对选定对象的</p>
<p>写锁(write locks)一直保持到事务结束；<br>读锁(read locks)在SELECT操作完成后马上释放；<br>不要求“范围锁(range-locks)”<br>所以READ COMMITTED只能保证读到的数据都是提交之后的数据，但是不能保证“可重复读”。在SELECT操作结束后就释放了共享锁，其他事务就可以对这个数据进行修改了，所以在本事务中再次读取这个数据，有可能已经改变。</p>
<h5 id="Repeatable-Read"><a href="#Repeatable-Read" class="headerlink" title="Repeatable Read"></a>Repeatable Read</h5><p>在可重复读(REPEATABLE READS)隔离级别中，基于锁机制并发控制的DBMS需要对选定对象的</p>
<p>读锁(read locks)和写锁(write locks)一直保持到事务结束；<br>但不要求“范围锁(range-locks)”；<br>读锁也保持到事务结束，自然就杜绝了一次事务过程中两次读取的数据不一致的问题。但是只锁住了SELECT相关的记录，还是可以往表中插入新的记录的。所以，幻读的问题没法解决。</p>
<h5 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h5><p>将事务的执行变成了串行的，自然就没有并发问题了。</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><h5 id="只读"><a href="#只读" class="headerlink" title="只读"></a>只读</h5><p>事务的第三个特性是它是否为只读事务。如果事务只对后端的数据库进行该操作，数据库可以利用事务的只读特性来进行一些特定的优化。通过将事务设置为只读，你就可以给数据库一个机会，让它应用它认为合适的优化措施。</p>
<h5 id="事务超时"><a href="#事务超时" class="headerlink" title="事务超时"></a>事务超时</h5><p>为了使应用程序很好地运行，事务不能运行太长的时间。因为事务可能涉及对后端数据库的锁定，所以长时间的事务会不必要的占用数据库资源。事务超时就是事务的一个定时器，在特定时间内事务如果没有执行完毕，那么就会自动回滚，而不是一直等待其结束。</p>
<h3 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h3><p><strong>@Transactional 可以作用于接口、接口方法、类以及类方法上。当作用于类上时，该类的所有 public 方法将都具有该类型的事务属性。</strong>同时，我们也可以在方法级别使用该标注来覆盖类级别的定义。</p>
<p>虽然 @Transactional 注解可以作用于接口、接口方法、类以及类方法上，但是 <strong>Spring 建议不要在接口或者接口方法上使用该注解，因为这只有在使用基于接口的代理时它才会生效。另外， @Transactional 注解应该只被应用到 public 方法上</strong>，这是由 Spring AOP 的本质决定的。如果你在 protected、private 或者默认可见性的方法上使用 @Transactional 注解，这将被忽略，也不会抛出任何异常。</p>
<p>默认情况下，<strong>只有来自外部的方法调用才会被AOP代理捕获</strong>，也就是，类内部方法调用本类内部的其他方法并不会引起事务行为，即使被调用方法使用@Transactional注解进行修饰。</p>
<h4 id="异常触发回滚的示例"><a href="#异常触发回滚的示例" class="headerlink" title="异常触发回滚的示例"></a>异常触发回滚的示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>  </span><br><span class="line"><span class="keyword">private</span> MyBatisDao dao;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span>  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Test test)</span> </span>&#123;  </span><br><span class="line">    dao.insert(test);  </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"test"</span>);<span class="comment">//抛出unchecked异常，触发事物，回滚  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="RuntimeException时不回滚的事务"><a href="#RuntimeException时不回滚的事务" class="headerlink" title="RuntimeException时不回滚的事务"></a>RuntimeException时不回滚的事务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(noRollbackFor=RuntimeException.class)  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Test test)</span> </span>&#123;  </span><br><span class="line">    dao.insert(test);  </span><br><span class="line">    <span class="comment">//抛出unchecked异常，触发事物，noRollbackFor=RuntimeException.class,不回滚  </span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"test"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="作用于类上"><a href="#作用于类上" class="headerlink" title="作用于类上"></a>作用于类上</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisServiceImpl</span> <span class="keyword">implements</span> <span class="title">MyBatisService</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> MyBatisDao dao; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Test test)</span> </span>&#123;  </span><br><span class="line">        dao.insert(test);  </span><br><span class="line">        <span class="comment">//抛出unchecked异常，触发事物，回滚  </span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"test"</span>);  </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置以非事务方式运行"><a href="#设置以非事务方式运行" class="headerlink" title="设置以非事务方式运行"></a>设置以非事务方式运行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(propagation=Propagation.NOT_SUPPORTED)  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Test test)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//事物传播行为是PROPAGATION_NOT_SUPPORTED，以非事务方式运行，不会存入数据库  </span></span><br><span class="line">    dao.insert(test);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置传播行为和隔离级别"><a href="#设置传播行为和隔离级别" class="headerlink" title="设置传播行为和隔离级别"></a>设置传播行为和隔离级别</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"businessSerivce"</span>)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessServiceImpl</span> <span class="keyword">implements</span> <span class="title">IBaseService</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    IStudentDao studentDao;  </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    IBaseServiceB baseServiceb;  </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT, 	rollbackFor = Exception.class)  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doA</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        Student st = <span class="keyword">new</span> Student();  </span><br><span class="line">        st.setId(<span class="number">1</span>);  </span><br><span class="line">        st.setSex(<span class="string">"girl"</span>);  </span><br><span class="line">        st.setUsername(<span class="string">"zx"</span>);  </span><br><span class="line">        studentDao.insertStudent(st);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><iframe src="/donate/?AliPayQR=/img/al.png&amp;WeChatQR=/img/wx.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/Java/">Java</a><a href="/tags/Spring/">Spring</a></div><div class="post-nav"><a class="pre" href="/2019/03/20/spring相关面试/">spring相关面试</a><a class="next" href="/2019/03/13/blog操作及具体指令/">blog操作及具体指令</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/小技能/">小技能</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/环境搭建/">环境搭建</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/破解/">破解</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/面试/">面试</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Auto-js/" style="font-size: 15px;">Auto.js</a> <a href="/tags/环境搭建/" style="font-size: 15px;">环境搭建</a> <a href="/tags/EFK/" style="font-size: 15px;">EFK</a> <a href="/tags/ElasticSearch/" style="font-size: 15px;">ElasticSearch</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/资源-软件破解/" style="font-size: 15px;">资源-软件破解</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Java基础/" style="font-size: 15px;">Java基础</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/pinpoint/" style="font-size: 15px;">pinpoint</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/springboot/" style="font-size: 15px;">springboot</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/01/21/一键部署springboot项目到docker/">一键部署springboot项目到docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/17/VMware安装黑苹果踩坑/">VMware安装黑苹果踩坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/19/Java基础整理/">Java基础整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/16/Navicat-12激活/">Navicat 12激活</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/06/SpringBoot学习-03-在IDEA上本地更新远程项目/">SpringBoot学习-03.在IDEA上本地更新远程项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/05/ThreadLocal理解/">ThreadLocal理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/05/SpringBoot学习-02-在IDEA上实现项目的远程调试/">SpringBoot学习-02.在IDEA上实现项目的远程调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/05/SpringBoot学习-01-实现微信接入/">SpringBoot学习-01.实现微信接入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/03/Auto-js学习/">Auto.js学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/02/文件对比神器Beyond-Compare4/">文件对比神器Beyond Compare4</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">二开的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>